<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ Teste Completo Supabase - CodeGen Studio</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/module.js" type="module"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: rgba(0, 217, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }

        h1 {
            color: #00d9ff;
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }

        .subtitle {
            color: #888;
            font-size: 1.1rem;
        }

        .status-banner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 400px;
            border: 2px solid #333;
            transition: all 0.3s ease;
        }

        .status-banner.connected {
            border-color: #00cc00;
            background: rgba(0, 204, 0, 0.1);
        }

        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff3333;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #00cc00;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .tab {
            padding: 12px 24px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 600;
        }

        .tab:hover {
            border-color: #00d9ff;
            background: #222;
        }

        .tab.active {
            background: linear-gradient(135deg, #00d9ff 0%, #00b8cc 100%);
            border-color: #00d9ff;
            color: #000;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #1a1a1a 0%, #222 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00d9ff, #00cc00);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            border-color: #00d9ff;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.2);
        }

        .card h2 {
            color: #00d9ff;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card p {
            color: #999;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #00d9ff 0%, #00b8cc 100%);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 217, 255, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.success {
            background: linear-gradient(135deg, #00cc00 0%, #009900 100%);
        }

        button.danger {
            background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
            color: white;
        }

        input,
        textarea {
            width: 100%;
            padding: 12px;
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #e0e0e0;
            margin-bottom: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #00d9ff;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
        }

        .output {
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            color: #00d9ff;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output.success {
            border-color: #00cc00;
            color: #00cc00;
            background: rgba(0, 204, 0, 0.05);
        }

        .output.error {
            border-color: #ff3333;
            color: #ff6666;
            background: rgba(255, 51, 51, 0.05);
        }

        .output.warning {
            border-color: #ffaa00;
            color: #ffdd00;
            background: rgba(255, 170, 0, 0.05);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid #00d9ff;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge.success {
            background: rgba(0, 204, 0, 0.2);
            border-color: #00cc00;
            color: #00cc00;
        }

        .badge.error {
            background: rgba(255, 51, 51, 0.2);
            border-color: #ff3333;
            color: #ff6666;
        }

        .divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #333, transparent);
            margin: 40px 0;
        }

        .instructions {
            background: linear-gradient(135deg, rgba(0, 217, 255, 0.05) 0%, rgba(0, 204, 0, 0.05) 100%);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .instructions h3 {
            color: #00d9ff;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .instructions ol {
            margin-left: 25px;
        }

        .instructions li {
            margin-bottom: 10px;
            color: #ccc;
        }

        .code-block {
            background: #0a0a0a;
            border-left: 4px solid #00d9ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .test-result {
            padding: 8px 12px;
            border-radius: 6px;
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .test-result.pass {
            background: rgba(0, 204, 0, 0.1);
            border-left: 4px solid #00cc00;
        }

        .test-result.fail {
            background: rgba(255, 51, 51, 0.1);
            border-left: 4px solid #ff3333;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üî¨ Teste Completo Supabase</h1>
            <p class="subtitle">Diagn√≥stico e Verifica√ß√£o de Integra√ß√µes</p>
        </header>

        <div id="statusBanner" class="status-banner">
            <div class="status-indicator"></div>
            <span>Carregando...</span>
        </div>

        <div class="instructions">
            <h3>üìã Como Usar</h3>
            <ol>
                <li><strong>Fa√ßa login</strong> primeiro usando a aba "üîê Autentica√ß√£o"</li>
                <li><strong>Teste cada se√ß√£o</strong> individualmente ou use "Executar Tudo"</li>
                <li><strong>Verifique as integra√ß√µes</strong> para garantir que todos os dados s√£o salvos</li>
                <li><strong>Resolva erros</strong> seguindo as mensagens indicadas em vermelho</li>
            </ol>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('auth')">üîê Autentica√ß√£o</div>
            <div class="tab" onclick="switchTab('projects')">üìÅ Projetos</div>
            <div class="tab" onclick="switchTab('integrations')">üîå Integra√ß√µes</div>
            <div class="tab" onclick="switchTab('database')">üíæ Banco de Dados</div>
            <div class="tab" onclick="switchTab('all')">üöÄ Executar Tudo</div>
        </div>

        <!-- TAB: Autentica√ß√£o -->
        <div id="tab-auth" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h2>1Ô∏è‚É£ Conex√£o com Supabase</h2>
                    <p>Verifica se o cliente Supabase est√° conectado</p>
                    <button onclick="testConnection()">Testar Conex√£o</button>
                    <div id="output-connection" class="output"></div>
                </div>

                <div class="card">
                    <h2>2Ô∏è‚É£ Login</h2>
                    <p>Fa√ßa login para testar as outras funcionalidades</p>
                    <input type="email" id="loginEmail" placeholder="Email">
                    <input type="password" id="loginPassword" placeholder="Senha">
                    <button onclick="testLogin()">Fazer Login</button>
                    <div id="output-login" class="output"></div>
                </div>

                <div class="card">
                    <h2>3Ô∏è‚É£ Verificar Sess√£o</h2>
                    <p>Verifica se voc√™ est√° autenticado</p>
                    <button onclick="testSession()">Verificar Sess√£o</button>
                    <div id="output-session" class="output"></div>
                </div>

                <div class="card">
                    <h2>4Ô∏è‚É£ Logout</h2>
                    <p>Encerrar sess√£o atual</p>
                    <button class="danger" onclick="testLogout()">Fazer Logout</button>
                    <div id="output-logout" class="output"></div>
                </div>
            </div>
        </div>

        <!-- TAB: Projetos -->
        <div id="tab-projects" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üìù Salvar Projeto</h2>
                    <p>Testa o salvamento de projetos no Supabase</p>
                    <input type="text" id="projectName" placeholder="Nome do projeto" value="TestProject">
                    <button onclick="testSaveProject()">Salvar Projeto de Teste</button>
                    <div id="output-save-project" class="output"></div>
                </div>

                <div class="card">
                    <h2>üìã Listar Projetos</h2>
                    <p>Lista todos os projetos salvos do usu√°rio</p>
                    <button onclick="testListProjects()">Listar Meus Projetos</button>
                    <div id="output-list-projects" class="output"></div>
                </div>

                <div class="card">
                    <h2>üóëÔ∏è Deletar Projeto de Teste</h2>
                    <p>Remove o √∫ltimo projeto de teste criado</p>
                    <button class="danger" onclick="testDeleteProject()">Deletar √öltimo Projeto</button>
                    <div id="output-delete-project" class="output"></div>
                </div>
            </div>
        </div>

        <!-- TAB: Integra√ß√µes -->
        <div id="tab-integrations" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üîë Salvar Token GitHub</h2>
                    <p>Testa salvamento do token de acesso do GitHub</p>
                    <input type="text" id="githubToken" placeholder="ghp_teste123...">
                    <button onclick="testSaveGithubToken()">Salvar Token</button>
                    <div id="output-github" class="output"></div>
                </div>

                <div class="card">
                    <h2>üóÑÔ∏è Salvar Integra√ß√£o Supabase</h2>
                    <p>Testa salvamento de credenciais Supabase</p>
                    <input type="text" id="supabaseUrl" placeholder="https://xxx.supabase.co">
                    <input type="text" id="supabaseAnonKey" placeholder="Anon Key">
                    <input type="text" id="supabaseServiceKey" placeholder="Service Key">
                    <button onclick="testSaveSupabase()">Salvar Supabase</button>
                    <div id="output-supabase" class="output"></div>
                </div>

                <div class="card">
                    <h2>üí≥ Salvar Integra√ß√£o Stripe</h2>
                    <p>Testa salvamento de chaves Stripe</p>
                    <input type="text" id="stripePublic" placeholder="pk_test_...">
                    <input type="text" id="stripeSecret" placeholder="sk_test_...">
                    <button onclick="testSaveStripe()">Salvar Stripe</button>
                    <div id="output-stripe" class="output"></div>
                </div>

                <div class="card">
                    <h2>üêò Salvar Integra√ß√£o Neon</h2>
                    <p>Testa salvamento de connection string Neon</p>
                    <textarea id="neonConnStr" placeholder="postgresql://user:pass@host/db" rows="3"></textarea>
                    <button onclick="testSaveNeon()">Salvar Neon</button>
                    <div id="output-neon" class="output"></div>
                </div>

                <div class="card full-width">
                    <h2>üîç Verificar Dados Salvos</h2>
                    <p>Carrega e exibe todas as integra√ß√µes salvas do perfil</p>
                    <button class="success" onclick="testLoadProfile()">Carregar Perfil Completo</button>
                    <div id="output-profile" class="output"></div>
                </div>
            </div>
        </div>

        <!-- TAB: Banco de Dados -->
        <div id="tab-database" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>üóÑÔ∏è Verificar Tabelas</h2>
                    <p>Testa acesso √†s tabelas profiles e projects</p>
                    <button onclick="testTables()">Verificar Tabelas</button>
                    <div id="output-tables" class="output"></div>
                </div>

                <div class="card">
                    <h2>üìä Verificar Colunas de profiles</h2>
                    <p>Lista todas as colunas da tabela profiles</p>
                    <button onclick="testProfileColumns()">Verificar Colunas</button>
                    <div id="output-columns" class="output"></div>
                </div>

                <div class="card">
                    <h2>üîí Verificar Pol√≠ticas RLS</h2>
                    <p>Verifica se as pol√≠ticas de seguran√ßa est√£o ativas</p>
                    <button onclick="testRLS()">Verificar RLS</button>
                    <div id="output-rls" class="output"></div>
                </div>
            </div>
        </div>

        <!-- TAB: Executar Tudo -->
        <div id="tab-all" class="tab-content">
            <div class="card full-width">
                <h2>üöÄ Diagn√≥stico Completo</h2>
                <p>Executa todos os testes em sequ√™ncia (exceto salvamento de integra√ß√µes)</p>
                <button class="success" onclick="runAllTests()" style="font-size: 1.1rem; padding: 18px;">‚ñ∂ Executar
                    Diagn√≥stico Completo</button>
                <div id="output-all" class="output"></div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="instructions">
            <h3>üíª Comandos de Console</h3>
            <p>Voc√™ tamb√©m pode executar os testes diretamente no console do navegador (F12):</p>
            <div class="code-block">
                // Testes individuais
                testConnection() // Testar conex√£o
                testLogin() // Login (precisa preencher campos antes)
                testSession() // Verificar sess√£o
                testSaveProject() // Salvar projeto
                testListProjects() // Listar projetos
                testSaveGithubToken() // Salvar token GitHub
                testSaveSupabase() // Salvar integra√ß√£o Supabase
                testSaveStripe() // Salvar integra√ß√£o Stripe
                testSaveNeon() // Salvar integra√ß√£o Neon
                testLoadProfile() // Carregar perfil completo
                testTables() // Verificar tabelas
                runAllTests() // Executar todos
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm';

        const supabaseUrl = 'https://oggabkywjtcghojhzepn.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nZ2Fia3l3anRjZ2hvamh6ZXBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNjIwNjIsImV4cCI6MjA3MTczODA2Mn0.x2eABhTnCuYMzLfl0Jzmn_BtXANW08rXlniikaLVsvU';

        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        window.supabase = supabase;

        let lastProjectId = null;

        // Utility functions
        function updateStatus(connected) {
            const banner = document.getElementById('statusBanner');
            const indicator = banner.querySelector('.status-indicator');
            const text = banner.querySelector('span');

            if (connected) {
                banner.classList.add('connected');
                indicator.classList.add('connected');
                text.textContent = '‚úÖ Supabase Conectado';
            } else {
                banner.classList.remove('connected');
                indicator.classList.remove('connected');
                text.textContent = '‚ùå Supabase Desconectado';
            }
        }

        window.switchTab = function (tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        };

        // Test functions
        window.testConnection = async function () {
            const output = document.getElementById('output-connection');
            try {
                const { data, error } = await supabase.auth.getSession();
                if (error) throw error;

                output.textContent = `‚úÖ SUCESSO\nüìç URL: ${supabaseUrl}\nüìç Status: Conectado`;
                output.className = 'output success';
                updateStatus(true);
            } catch (err) {
                output.textContent = `‚ùå ERRO\n${err.message}`;
                output.className = 'output error';
                updateStatus(false);
            }
        };

        window.testLogin = async function () {
            const output = document.getElementById('output-login');
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                output.textContent = '‚ö†Ô∏è Preencha email e senha';
                output.className = 'output warning';
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;

                output.textContent = `‚úÖ LOGIN BEM-SUCEDIDO!\nüìç Email: ${data.user.email}\nüìç ID: ${data.user.id}`;
                output.className = 'output success';
                updateStatus(true);
            } catch (err) {
                output.textContent = `‚ùå FALHA NO LOGIN\n${err.message}`;
                output.className = 'output error';
            }
        };

        window.testSession = async function () {
            const output = document.getElementById('output-session');
            try {
                const { data: { session } } = await supabase.auth.getSession();

                if (session) {
                    output.textContent = `‚úÖ SESS√ÉO ATIVA\nüìç User: ${session.user.email}\nüìç ID: ${session.user.id}\nüìç Expira: ${new Date(session.expires_at * 1000).toLocaleString()}`;
                    output.className = 'output success';
                } else {
                    output.textContent = '‚ö†Ô∏è NENHUMA SESS√ÉO ATIVA\nFa√ßa login primeiro';
                    output.className = 'output warning';
                }
            } catch (err) {
                output.textContent = `‚ùå ERRO\n${err.message}`;
                output.className = 'output error';
            }
        };

        window.testLogout = async function () {
            const output = document.getElementById('output-logout');
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;

                output.textContent = '‚úÖ LOGOUT REALIZADO COM SUCESSO';
                output.className = 'output success';
                updateStatus(false);
            } catch (err) {
                output.textContent = `‚ùå ERRO AO FAZER LOGOUT\n${err.message}`;
                output.className = 'output error';
            }
        };

        window.testSaveProject = async function () {
            const output = document.getElementById('output-save-project');
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                output.textContent = '‚ùå Fa√ßa login primeiro';
                output.className = 'output error';
                return;
            }

            const projectName = document.getElementById('projectName').value || 'TestProject';

            try {
                const { data, error } = await supabase
                    .from('projects')
                    .insert({
                        user_id: session.user.id,
                        name: projectName,
                        files: [{ name: 'test.html', language: 'html', content: '<h1>Test</h1>' }],
                        chat_history: [],
                        env_vars: {}
                    })
                    .select()
                    .single();

                if (error) throw error;

                lastProjectId = data.id;
                output.textContent = `‚úÖ PROJETO SALVO!\nüìç ID: ${data.id}\nüìç Nome: ${data.name}\nüìç Criado em: ${new Date(data.created_at).toLocaleString()}`;
                output.className = 'output success';
            } catch (err) {
                output.textContent = `‚ùå ERRO AO SALVAR\n${err.message}\nüìã C√≥digo: ${err.code}`;
                output.className = 'output error';
            }
        };

        window.testListProjects = async function () {
            const output = document.getElementById('output-list-projects');
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                output.textContent = '‚ùå Fa√ßa login primeiro';
                output.className = 'output error';
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('projects')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    output.textContent = '‚ö†Ô∏è Nenhum projeto encontrado';
                    output.className = 'output warning';
                } else {
                    output.textContent = `‚úÖ ${data.length} PROJETO(S) ENCONTRADO(S)\n\n` +
                        data.map((p, i) => `${i + 1}. ${p.name}\n   ID: ${p.id}\n   Arquivos: ${p.files.length}\n   Criado: ${new Date(p.created_at).toLocaleString()}`).join('\n\n');
                    output.className = 'output success';
                }
            } catch (err) {
                output.textContent = `‚ùå ERRO\n${err.message}`;
                output.className = 'output error';
            }
        };

        window.testDeleteProject = async function () {
            const output = document.getElementById('output-delete-project');

            if (!lastProjectId) {
                output.textContent = '‚ö†Ô∏è Nenhum projeto para deletar\n(Crie um projeto de teste primeiro)';
                output.className = 'output warning';
                return;
            }

            try {
                const { error } = await supabase
                    .from('projects')
                    .delete()
                    .eq('id', lastProjectId);

                if (error) throw error;

                output.textContent = `‚úÖ PROJETO DELETADO!\nüìç ID: ${lastProjectId}`;
                output.className = 'output success';
                lastProjectId = null;
            } catch (err) {
                output.textContent = `‚ùå ERRO\n${err.message}`;
                output.className = 'output error';
            }
        };

        window.testSaveGithubToken = async function () {
            const output = document.getElementById('output-github');
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                output.textContent = '‚ùå Fa√ßa login primeiro';
                output.className = 'output error';
                return;
            }

            const token = document.getElementById('githubToken').value || 'ghp_test_' + Date.now();

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .upsert({
                        id: session.user.id,
                        github_access_token: token
                    })
                    .select();

                if (error) throw error;

                output.textContent = `‚úÖ TOKEN GITHUB SALVO!\nüìç Token: ${token.substring(0, 20)}...\n\nRecarregando perfil para verificar...`;
                output.className = 'output success';

                // Verificar se salvou
                setTimeout(async () => {
                    const { data: profileData } = await supabase
                        .from('profiles')
                        .select('github_access_token')
                        .eq('id', session.user.id)
                        .single();

                    if (profileData?.github_access_token === token) {
                        output.textContent += '\n\n‚úÖ VERIFICADO: Token persistiu no banco!';
                    } else {
                        output.textContent += '\n\n‚ùå AVISO: Token n√£o foi encontrado no banco ap√≥s salvar!';
                        output.className = 'output error';
                    }
                }, 1000);
            } catch (err) {
                output.textContent = `‚ùå ERRO\n${err.message}`;
                output.className = 'output error';
            }
        };

        window.testSaveSupabase = async function () {
            const output = document.getElementById('output-supabase');
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                output.textContent = '‚ùå Fa√ßa login primeiro';
                output.className = 'output error';
                return;
            }

            const url = document.getElementById('supabaseUrl').value || 'https://test.supabase.co';
            const anonKey = document.getElementById('supabaseAnonKey').value || 'test_anon_key_' + Date.now();
            const serviceKey = document.getElementById('supabaseServiceKey').value || 'test_service_key_' + Date.now();

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .upsert({
                        id: session.user.id,
                        supabase_project_url: url,
                        supabase_anon_key: anonKey,
                        supabase_service_key: serviceKey
                    })
                    .select();

                if (error) throw error;

                output.textContent = `‚úÖ INTEGRA√á√ÉO SUPABASE SALVA!\nüìç URL: ${url}\nüìç Anon Key: ${anonKey.substring(0, 20)}...\nüìç Service Key: ${serviceKey.substring(0, 20)}...`;
                output.className = 'output success';
            } catch (err) {
                output.textContent = `‚ùå ERRO\n${err.message}`;
                output.className = 'output error';
            }
        };

        window.testSaveStripe = async function () {
            const output = document.getElementById('output-stripe');
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                output.textContent = '‚ùå Fa√ßa login primeiro';
                output.className = 'output error';
                return;
            }

            const publicKey = document.getElementById('stripePublic').value || 'pk_test_' + Date.now();
            const secretKey = document.getElementById('stripeSecret').value || 'sk_test_' + Date.now();

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .upsert({
                        id: session.user.id,
                        stripe_public_key: publicKey,
                        stripe_secret_key: secretKey
                    })
                    .select();

                if (error) throw error;

                output.textContent = `‚úÖ INTEGRA√á√ÉO STRIPE SALVA!\nüìç Public Key: ${publicKey.substring(0, 20)}...\nüìç Secret Key: ${secretKey.substring(0, 20)}...`;
                output.className = 'output success';
            } catch (err) {
                output.textContent = `‚ùå ERRO\n${err.message}`;
                output.className = 'output error';
            }
        };

        window.testSaveNeon = async function () {
            const output = document.getElementById('output-neon');
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                output.textContent = '‚ùå Fa√ßa login primeiro';
                output.className = 'output error';
                return;
            }

            const connStr = document.getElementById('neonConnStr').value || 'postgresql://test:pass@localhost/db';

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .upsert({
                        id: session.user.id,
                        neon_connection_string: connStr
                    })
                    .select();

                if (error) throw error;

                output.textContent = `‚úÖ INTEGRA√á√ÉO NEON SALVA!\nüìç Connection String: ${connStr.substring(0, 40)}...`;
                output.className = 'output success';
            } catch (err) {
                output.textContent = `‚ùå ERRO\n${err.message}`;
                output.className = 'output error';
            }
        };

        window.testLoadProfile = async function () {
            const output = document.getElementById('output-profile');
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                output.textContent = '‚ùå Fa√ßa login primeiro';
                output.className = 'output error';
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();

                if (error) throw error;

                const fields = [
                    { name: 'GitHub Token', value: data.github_access_token },
                    { name: 'Supabase URL', value: data.supabase_project_url },
                    { name: 'Supabase Anon Key', value: data.supabase_anon_key },
                    { name: 'Supabase Service Key', value: data.supabase_service_key },
                    { name: 'Stripe Public Key', value: data.stripe_public_key },
                    { name: 'Stripe Secret Key', value: data.stripe_secret_key },
                    { name: 'Neon Connection', value: data.neon_connection_string },
                    { name: 'OpenRouter Key', value: data.openrouter_api_key },
                    { name: 'GCP Project ID', value: data.gcp_project_id },
                    { name: 'Firebase Project ID', value: data.firebase_project_id }
                ];

                let result = '‚úÖ PERFIL CARREGADO\n\n';
                let filledCount = 0;

                fields.forEach(field => {
                    const status = field.value ? '‚úÖ' : '‚ùå';
                    const preview = field.value ?
                        (field.value.length > 30 ? field.value.substring(0, 30) + '...' : field.value) :
                        'n√£o configurado';
                    result += `${status} ${field.name}: ${preview}\n`;
                    if (field.value) filledCount++;
                });

                result += `\nüìä ${filledCount}/${fields.length} campos preenchidos`;

                output.textContent = result;
                output.className = 'output success';
            } catch (err) {
                output.textContent = `‚ùå ERRO\n${err.message}`;
                output.className = 'output error';
            }
        };

        window.testTables = async function () {
            const output = document.getElementById('output-tables');
            try {
                const { error: e1 } = await supabase.from('profiles').select('count').limit(1);
                const { error: e2 } = await supabase.from('projects').select('count').limit(1);

                if (e1 || e2) {
                    output.textContent = `RESULTADOS:\n\n` +
                        `${e1 ? '‚ùå' : '‚úÖ'} profiles: ${e1?.message || 'Acess√≠vel'}\n` +
                        `${e2 ? '‚ùå' : '‚úÖ'} projects: ${e2?.message || 'Acess√≠vel'}`;
                    output.className = e1 || e2 ? 'output error' : 'output success';
                } else {
                    output.textContent = '‚úÖ AMBAS AS TABELAS ACESS√çVEIS\n\n‚úÖ profiles\n‚úÖ projects';
                    output.className = 'output success';
                }
            } catch (err) {
                output.textContent = `‚ùå ERRO\n${err.message}`;
                output.className = 'output error';
            }
        };

        window.testProfileColumns = async function () {
            const output = document.getElementById('output-columns');
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                output.textContent = '‚ùå Fa√ßa login primeiro';
                output.className = 'output error';
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();

                if (error) throw error;

                const columns = Object.keys(data);
                output.textContent = `‚úÖ ${columns.length} COLUNAS ENCONTRADAS\n\n` +
                    columns.map(col => `‚Ä¢ ${col}`).join('\n');
                output.className = 'output success';
            } catch (err) {
                output.textContent = `‚ùå ERRO\n${err.message}`;
                output.className = 'output error';
            }
        };

        window.testRLS = async function () {
            const output = document.getElementById('output-rls');
            output.textContent = '‚ö†Ô∏è Esta funcionalidade requer acesso direto ao PostgreSQL\n\nPara verificar RLS:\n1. Acesse Supabase Dashboard\n2. V√° em Database ‚Üí Policies\n3. Verifique se profiles e projects t√™m pol√≠ticas ativas';
            output.className = 'output warning';
        };

        window.runAllTests = async function () {
            const output = document.getElementById('output-all');
            output.textContent = '‚è≥ EXECUTANDO DIAGN√ìSTICO COMPLETO...\n\n';
            output.className = 'output warning';

            const tests = [
                { name: 'Conex√£o', fn: testConnection },
                { name: 'Sess√£o', fn: testSession },
                { name: 'Tabelas', fn: testTables },
                { name: 'Listar Projetos', fn: testListProjects }
            ];

            for (const test of tests) {
                output.textContent += `üîÑ Testando ${test.name}...\n`;
                await test.fn();
                await new Promise(r => setTimeout(r, 500));
            }

            output.textContent += '\n‚úÖ DIAGN√ìSTICO COMPLETO!\n\nVerifique os resultados nas abas espec√≠ficas.';
            output.className = 'output success';
        };

        // Auto-test on load
        setTimeout(() => {
            testConnection();
            testSession();
        }, 1000);
    </script>
</body>

</html>